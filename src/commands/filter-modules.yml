description: |
  Filter the list of modules (directories) provided in the shared config to those that contain changes.
parameters:
  modules:
    description: |
      Directories which should be built upon changes.
      Each row represents a space-separated list of the root directories for modules, each of which must have its own `.circleci/config.yml`.
      The first item of the list will be tested for changes, and will be added to the filtered list of modules if there are any changes.
      The subsequent items, if there are any, will also be added to the filtered list of modules if there are any changes in the directory specified as the first item.
      CAVEAT: Directory names having white spaces cannot be specified.
    type: string
  modules-filtered:
    description: Path to the file where the filtered list of modules is generated
    type: string
    default: /tmp/modules-filtered.txt
  force-all:
    description: Forcibly build all the modules
    type: boolean
    default: false
steps:
  - run:
      name: Generate the list of modules having changes
      command: |
        cat \<< EOD | sed -e '/^$/d' | while read row; do module="$(echo "$row" | awk '{ print $1 }')"; if [ << parameters.force-all >> == 'true' ] || [ "$(git diff-tree --no-commit-id --name-only -r HEAD "$module")" != "" ]; then echo "$row" | sed -e 's/ /\n/g' >> << parameters.modules-filtered >>; fi; done
        # Add each module to `modules-filtered` if 1) `force-all` is set to `true`, or 2) there is a diff against the previous commit
        << parameters.modules >>
        EOD
